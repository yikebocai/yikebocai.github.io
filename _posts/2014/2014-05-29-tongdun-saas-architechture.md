---
layout: post
title: 反欺诈SAAS服务技术架构
categories: tongdun
tags: 
- architecture
---

>经过三个多月的研发和试用，我们的反欺诈SAAS服务已正式在线上运行，具备了基本的分布式系统的雏形，虽说之前对这一套挺熟悉的，但那是建立在阿里强大的基本平台和兄弟部门支撑的基础上，对创业公司来说从头构建一套系统不是那么容易的，正所谓知易行难，关键在细节。

## 服务器和虚拟化

硬件可供选择的余地不是很大，DELL、IBM用的还是比较多，前者的性价比更高一点，刚好有人介绍了一家DELL在杭州的经销商，价格还可以就选用了DELL的服务器，最近又加了好多台服务器都是这家的，后面要再找供应商了解下，货比三家么。

应用服务器使用了两颗的`Xeon`四核处理器，内存是16G，硬盘选用了`SSD`硬盘，相对传统机械硬盘`SSD`对IO密集形的服务来说性能提升明显，但现在想来其实应用服务器读写磁盘的时候很少，是没必要用`SSD`硬盘的，倒是数据库应该使用，阿里的MySQL服务器近两年基本都升级到了`SSD`，这对性能的提升还是非常明显的。数据库是应用的核心系统，因此使用了2U的服务器，内存加大到了32G，但大容量的`SSD`硬盘的价格实在太贵，退而求期次使用了15000转的`SAS`硬盘，做了性价比最高的`RAID5`方案，这样保证在一块硬盘坏掉时数据不丢失。缓存服务器使用了48G大内存小硬盘的配置，应付短期内的业务需求应该没什么问题。

根据之前在阿里的经验，应用服务器一般都是用`Xen`做虚拟化，但我们自己在这方面缺少经验，因此还是根据供应商的建议使用`VMWare`的虚拟化方案，因为一开始经验不足，应用服务器的选型也不太合理，两颗四核CPU十六G内存只能虚两台出来，每台分8G有点浪费，虚四台CPU又有点弱，关键是1U的服务器只虚两台也占用一个机位搬托管费用一年就是2800块，太不划算了，后来都干脆买了更高的配置，多虚几台出来。

但在每台物理机上虚N台的方式不能统一管理服务器资源缺乏弹性，在我的理想中应该是可以把一堆物理统一管理起来，然后在上面做虚机，底层物理机的资料管理维护和上层虚拟机相分离，接近私有云的概念。大概了解了最近非常火的`OpenStack`和`CloudStack`解决方案，感觉都还比较复杂，不是我们初创公司能玩的起的，但我觉得今后反欺诈的SAAS服务肯定应该构建在私有云的基础上，最近在找运维人员时特别留意是否有关注这块的人才。

## 负载均衡和集群

因为我们提供的是SAAS服务，目标是为大量的互联网企业用户提供服务，因此这个系统一开始就要求是基于互联网架构的分布式系统，对高可用性、高可扩展性、高并发性都有非常高的要求。

### Apache代理

最前端是用`Apache`做了反向代理，这台机器绑定电信和联通的双IP，分配了10M的独享带宽。之前很长一段时间老是搞不清楚反向代理是什么意思，后来和正向代理做了对比才弄清楚，原来像局域网代理上网，是内网机器通过一台代理服务器访问互联网叫正向代理，而外面的用户通过`Apache`或`Nginx`访问内部实际的应用服务器和它正相反，所以叫反向代理。在Apache的配置中启用了`mod_proxy`和`mod_proxy_balance`模块，使用了反向代理和负载匀衡的功能。负载匀衡算法常见的有`轮询`、`随机`、`权重`等，Apache这里默认的是随机算法。Apache和后面的Tomcat应用服务器，通过`HTTP`的方式实现连接，当然也可以使用更高效的`AJP`协议，它是二进制的传输效率相对来高一点。当初只所以没有用非常流行的`Nginx`，主要还是没人熟悉，而Apache相对了解一点，相对而言快速开发上线接入客户比更完美的技术架构更重要。

但是所有的入口都走Apache的话，就存在单点的问题，万一Apache这台机器挂掉后，后面所有的服务都将无法访问，这对提供SAAS服务的网站来说绝对无法容忍，因此有了`Keepalived`和`Heartbeat`这样的热备方案，主机叫Master，备机叫Slave，主备之前通过心跳来检测状态是否正常，一但发现主机没有反映，将自动启用备机。当然，当主机恢复正常时，备机将再次交出控制权退居幕后。实现的机制除了心跳检测外，最重要的是IP的漂移技术。正常情况下，服务器上启用两个网上`eth0`和`eth1`，分别配置内网和公网IP，如果要实现热备就要求自动把公网IP绑定到备机上，这里就用到[Virtual IP](http://en.wikipedia.org/wiki/Virtual_IP_address)的概念。实际上公网IP并不是想像的那样，是被`Keepalived`自动修改网卡配置然后重启后网卡后生效的，而是请求方通过`ARP`协议在网络中查找该IP对应的`Mac`地址是多少，正常时主机告诉请求方自己的`Mac`地址，切换由后备机响应，这样请求就能发送到真实的服务器上，从而实现了`Failover`。对VIP原理的解释请参考这篇文章[虚拟IP切换原理](http://blog.csdn.net/zhang9981204/article/details/6316333)。

### Tomcat应用

应用系统是多台机器的Cluster，使用了轻量级的Tomcat应用服务器，前面做了Apache的反向代理，

## Memcache缓存
##MySQL数据库
## 系统运维和发布

